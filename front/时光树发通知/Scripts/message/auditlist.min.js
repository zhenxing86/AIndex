$(function () { function d(a, b) { var c = function (a) { return a += "", a.replace(/^(\d)$/, "0$1") }, d = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"], e = { yyyy: a.getFullYear(), yy: a.getFullYear().toString().substring(2), M: a.getMonth() + 1, MM: c(a.getMonth() + 1), d: a.getDate(), dd: c(a.getDate()), hh: c(a.getHours() % 12), HH: c(a.getHours()), mm: c(a.getMinutes()), ss: c(a.getSeconds()), w: d[a.getDay()] }; return b || (b = "yyyy-MM-dd HH:mm:ss"), b.replace(/([a-z])(\1)*/gi, function (a) { return e[a] }) } function i(c) { $.ajax({ url: "/message/sendhistorydata", data: { aftertime: document.querySelector("#aftertime").value, uid: document.querySelector("#uid").value }, success: function (c) { return c[0] && 0 != c.length ? (b.messages = b.messages.concat(c), document.querySelector("#aftertime").value = c[c.length - 1].writetime, this.messages = b.messages, setTimeout(function () { a.update().check().handlers(!0) }, 10), void 0) : (this.nomore = !0, void 0) }.bind(c), complete: function () { this.getting = !1 }.bind(c) }) } var e, f, g, h, a = Layzr({ normal: "data-src", threshold: 10 }), b = { messages: [] }, c = { message: {}, receiver: "", teachers: [], classes: [] }; Vue.component("Msg", { template: "#msg", props: ["message"], data: function () { return { teachers: [], classes: [] } }, methods: { detail: function () { c = { message: this.message, receiver: this.receiver, teachers: this.teachers, classes: this.classes }, h.go({ name: "aduit" }) } }, computed: { receiver: function () { var a = []; return this.teachers.length > 0 && a.push("老师" + this.teachers.length + "人"), a = a.concat(this.classes), a.join(",") || "加载中..." } }, ready: function () { $.ajax({ url: "/message/GetReceivers", data: { taskid: this.message.taskid, kid: document.querySelector("#kid").value, messagetype: this.message.type, state: this.message.state }, success: function (a) { var d, e, b = [], c = []; for (d = 0; d < a.read.length; d++) for (e = 0; e < a.read[d].member.length; e++) 1 == a.read[d].member[e].usertype ? b.push(a.read[d].member[e]) : c.indexOf(a.read[d].name) < 0 && c.push(a.read[d].name); for (d = 0; d < a.unread.length; d++) for (e = 0; e < a.unread[d].member.length; e++) 1 == a.unread[d].member[e].usertype ? b.push(a.unread[d].member[e]) : c.indexOf(a.unread[d].name) < 0 && c.push(a.unread[d].name); this.teachers = b, this.classes = c }.bind(this) }) } }), Vue.component("MsgImg", { template: "#msg-img", props: ["imgs"], methods: { show: function (a) { var c, b = []; for (c = 0; c < this.imgs.length; c++) b.push(this.imgs[c].url); zyapp().com.showImgs(b[a], b, a) } } }), Vue.component("MsgImg2", { template: "#msg-img2", props: ["imgs"], methods: { show: function (a) { var c, b = []; for (c = 0; c < this.imgs.length; c++) b.push(this.imgs[c].url); zyapp().com.showImgs(b[a], b, a) } } }), Vue.component("MsgAudio", { template: "#msg-audio", data: function () { return { length: "", playing: !1 } }, props: ["audio"], methods: { play: function () { var a = this.$el.querySelector("audio"); this.playing ? (a.pause(), a.currentTime = 0) : a.play(), this.playing = !this.playing }, ended: function () { var a = this.$el.querySelector("audio"); a.pause(), a.currentTime = 0, this.playing = !this.playing }, loadedmetadata: function () { var a = this.$el.querySelector("audio"), b = parseInt(a.duration); this.length = b ? b + '"' : "&nbsp;" }, loaderror: function () { this.audio = "", this.length = "" } } }), Vue.component("MsgAudio2", { template: "#msg-audio2", data: function () { return { length: "", playing: !1 } }, props: ["audio"], methods: { play: function () { var a = this.$el.querySelector("audio"); parseInt(a.duration) && (this.playing ? (a.pause(), a.currentTime = 0) : a.play(), this.playing = !this.playing) }, ended: function () { var a = this.$el.querySelector("audio"); a.pause(), a.currentTime = 0, this.playing = !this.playing }, loadedmetadata: function () { var a = this.$el.querySelector("audio"), b = parseInt(a.duration); this.length = b ? b + '"' : "&nbsp;" }, loaderror: function () { this.audio = "", this.length = "" } } }), Vue.component("MsgVideo", { template: "#msg-video", props: ["video"], methods: { play: function () { zyapp().com.playVideo(this.video) } } }), Vue.component("MsgVideo2", { template: "#msg-video2", props: ["video"], methods: { play: function () { zyapp().com.playVideo(this.video) } } }), Vue.component("SelectList", { template: "#select-list", props: ["groups"], data: function () { }, methods: { toggle: function (a) { this.groups[a].open = !this.groups[a].open } } }), Vue.component("Confirm", { template: "#confirm", props: ["show", "info", "yes", "no", "yestext", "notext"], watch: { show: function (a) { a ? document.body.classList.add("overflow") : document.body.classList.remove("overflow") } }, ready: function () { this.show && document.body.classList.add("overflow") }, beforeDestroy: function () { document.body.classList.remove("overflow") } }), Vue.filter("dateformat2", function (a) { return d(new Date(a.replace(/-/g, "/")), "M月d日") }), Vue.filter("dateformat", function (a) { var b = new Date, c = new Date(b.getTime() - 864e5); return a.indexOf(d(b, "yyyy-MM-dd")) >= 0 ? d(new Date(a.replace(/-/g, "/")), "HH:mm:ss") : a.indexOf(d(c, "yyyy-MM-dd")) >= 0 ? "昨天 " + d(new Date(a.replace(/-/g, "/")), "HH:mm:ss") : d(new Date(a.replace(/-/g, "/")), "yyyy-MM-dd HH:mm:ss") }), Vue.filter("dateformat3", function (a) { return d(new Date(a.replace(/-/g, "/")), "yyyy-MM-dd HH:mm") }), e = Vue.extend({ template: "#main", data: function () { return { messages: [], getting: !1, nomore: !1 } }, methods: { getmore: function (b) { a.update().check().handlers(!0); var c = b.target; c.scrollTop + c.clientHeight + 50 > c.scrollHeight && !this.getting && !this.nomore && (this.getting = !0, i(this)) } }, ready: function () { i(this) } }), f = Vue.extend({ template: "#aduit", data: function () { return { message: c.message, receiver: c.receiver, teachers: c.teachers, classes: c.classes, open: !1, auditing: !1, confirm: { isShow: !1, info: "", yesText: "确定", noText: "取消" }, setState: 0 } }, computed: { receivers: function () { var b, a = []; for (b = 0; b < this.classes.length; b++) a.push(this.classes[b]); for (b = 0; b < this.teachers.length; b++) a.push(this.teachers[b].name); return a } }, methods: { toggle: function () { this.open = !this.open }, pass: function () { this.setState = 1, this.confirm = { isShow: !0, info: "确认审核通过？", yesText: "确定", noText: "取消" } }, reject: function () { this.setState = 2, this.confirm = { isShow: !0, info: "确认审核不通过？", yesText: "确定", noText: "取消" } }, yes: function () { this.auditing || (this.auditing = !0, this.confirm.info = "正在提交审核结果...", $.ajax({ url: "/message/auditMessage", data: { taskid: this.message.taskid, uid: document.querySelector("#uid").value, messagetype: this.message.type, state: this.setState }, success: function () { $.ajax({ url: "/message/MessageGetModel", data: { uid: document.querySelector("#uid").value, taskid: this.message.taskid, messagetype: this.message.type, state: this.setState }, success: function (a) { this.confirm.isShow = !1, this.auditing = !1, a ? (this.confirm = { isShow: !0, info: "操作成功", yesText: "", noText: "确定" }, this.message.state = a.state) : this.confirm = { isShow: !0, info: "操作失败，请重试", yesText: "", noText: "确定" } }.bind(this) }) }.bind(this), error: function () { this.confirm.isShow = !1, this.confirm = { isShow: !0, info: "操作失败，请重试", yesText: "", noText: "确定" } }.bind(this) })) }, no: function () { this.auditing || (this.confirm.isShow = !1) } }, route: { activate: function () { document.querySelector(".content").style.overflow = "hidden" }, deactivate: function () { document.querySelector(".content").style.overflow = "auto" } } }), g = Vue.extend({}), h = new VueRouter, h.map({ "/": { component: e, subRoutes: { "/aduit": { name: "aduit", component: f } } } }), h.start(g, "#app") });