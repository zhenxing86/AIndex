$(function () { function o() { var d, e, f, a = JSON.parse(JSON.stringify(b)), c = []; for (d = 0; d < a.imgs.length; d++) c.push(a.imgs[d].url); for (e = [], d = 0; d < a.students.length; d++) -1 == e.indexOf(a.students[d]) && e.push(a.students[d]); for (a.students = e.sort(function (a, b) { return a - b }).join(","), f = [], d = 0; d < a.teachers.length; d++) -1 == f.indexOf(a.teachers[d]) && f.push(a.teachers[d]); return a.teachers = f.sort(function (a, b) { return a - b }).join(","), { content: a.content, imgs: c.join(","), audio: a.audio, video: a.video, uid: a.sender, kid: a.kid, students: a.students, teachers: a.teachers, needAudit: 0 == a.messagetype ? document.querySelector("#auditSms").value : document.querySelector("#appAuditSms").value, role: document.querySelector("#role").value || 1, smstype: 0 == (document.querySelector("#role").value || 1) ? 2 : 1, messagetype: a.messagetype, istime: a.sendtime ? 1 : 0, sendtime: a.sendtime } } function p(a) { var c, d; return b.checked ? !0 : (c = !1, 0 == b.students.length + b.teachers.length ? (a.beforeSend.isShow = !1, zyapp().com.alert("请选择接收人"), a.sendding = !1) : (a.beforeSend = { isShow: !0, info: "正在检查消息内容...", yesText: "", noText: "" }, d = o(), $.ajax({ url: "/Message/CheckMsg", data: d, async: !1, type: "POST", success: function (b) { a.beforeSend.isShow = !1, -1 == b.result ? zyapp().com.alert("内容存在非法关键字【" + b.info + "】") : -2 == b.result ? a.confirm = 0 == d.messagetype ? { isShow: !0, info: "您已经发送过相同内容的短信，是否继续发送？", yesText: "确定", noText: "取消" } : { isShow: !0, info: "您已经发送过相同内容的消息，是否继续发送？", yesText: "确定", noText: "取消" } : c = !0 }.bind(a), error: function () { c = !0, a.beforeSend.isShow = !1 } })), b.checked = c, c) } function q(a) { var b = o(); $.ajax({ url: "/message/SendSMS", data: b, type: "POST", success: function (c) { if (1 == c.result) { var d = b.students ? b.students.split(",").length : 0 + !!b.teachers ? b.teachers.split(",").length : 0, e = d - c.sendCount, g = (e - c.notVip, "选择" + d + "人," + "已发" + c.sendCount + "人," + "未发" + e + "人"); a.confirm = { isShow: !0, info: g, yesText: "", noText: "确定" } } else 2 == c.result ? zyapp().com.alert("短信数量不足，请联系客服充值！") : 3 == c.result ? (zyapp().com.toast("已经提交，需要园长审核后才能发送！"), zyapp().com.newWindow("/message/sendhistory?uid={uid}&kid={kid}&role={role}"), history.go(-2), setTimeout(function () { location.reload() }, 500)) : zyapp().com.alert("发送失败") }, error: function () { zyapp().com.alert("发送失败") }, complete: function () { a.sendding = !1 }.bind(a) }) } function r(a) { if (!a.sendding) { a.sendding = !0; var b = o(); $.ajax({ url: "/message/SendAndNotice", data: b, type: "POST", success: function (a) { 1 == a ? (zyapp().com.toast("发送成功"), zyapp().com.newWindow("/message/sendhistory?uid={uid}&kid={kid}&role={role}"), history.go(-3)) : 3 == a && (zyapp().com.toast("已经提交，需要园长审核后才能发送！"), zyapp().com.newWindow("/message/sendhistory?uid={uid}&kid={kid}&role={role}"), history.go(-3)) }, error: function () { zyapp().com.alert("发送失败") }, complete: function () { a.sendding = !1 }.bind(a) }) } } function s(a, b) { var c = function (a) { return a += "", a.replace(/^(\d)$/, "0$1") }, d = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"], e = { yyyy: a.getFullYear(), yy: a.getFullYear().toString().substring(2), M: a.getMonth() + 1, MM: c(a.getMonth() + 1), d: a.getDate(), dd: c(a.getDate()), hh: c(a.getHours() % 12), HH: c(a.getHours()), mm: c(a.getMinutes()), ss: c(a.getSeconds()), w: d[a.getDay()] }; return b || (b = "yyyy-MM-dd HH:mm:ss"), b.replace(/([a-z])(\1)*/gi, function (a) { return e[a] }) } function t(a) { return /^1[3|4|5|7|8]\d{9}$/.test(a) } var a, b, c, d, e, f, g, h, i, j, k, l, m, n; Vue.filter("isMobileIllegal", function (a) { return !/^1[3|4|5|7|8]\d{9}$/.test(a) }), a = { students: [], teachers: [], surpluscnt: document.querySelector("#surpluscnt").value || 0, smsLen: document.querySelector("#smsLen").value || 0 }, b = { kid: document.querySelector("#kid").value, sender: document.querySelector("#uid").value, smstype: document.querySelector("#smstype").value, imgs: [], audio: "", content: "", video: "", time: null, receipt: 1, teachers: [], students: [], istime: 0, sendtime: "", messagetype: 0, checked: !1 }, c = JSON.parse(JSON.stringify(b)), Vue.component("ImgEditor", { template: "#img-editor", props: ["imgs", "maxcnt", "uploadimgs"], methods: { show: function (a) { var c, b = []; for (c = 0; c < this.imgs.length; c++) b.push(this.imgs[c].url); zyapp().com.delImgs(b[a], b, a, "updateimgs") } }, ready: function () { } }), Vue.component("AudioEditor", { template: "#audio-editor", props: ["audio"], data: function () { return { playing: !1, length: "", confirm: { isShow: !1, info: "是否删除该音频" } } }, methods: { play: function () { var a = this.$el.querySelector("audio"); this.playing ? (a.pause(), a.currentTime = 0) : a.play(), this.playing = !this.playing }, ended: function () { var a = this.$el.querySelector("audio"); a.pause(), a.currentTime = 0, this.playing = !this.playing }, loadedmetadata: function () { var a = this.$el.querySelector("audio"), b = parseInt(a.duration); this.length = b ? b + '"' : "&nbsp;" }, loaderror: function () { this.audio = "", this.length = "" }, del: function () { this.confirm.isShow = !0 }, yes: function () { n.app.$children[0].$set("audio", ""), b.audio = "", this.confirm.isShow = !1 }, no: function () { this.confirm.isShow = !1 } } }), Vue.component("VideoEditor", { template: "#video-editor", props: ["video", "uploadvideo"], data: function () { return { confirm: { isShow: !1, info: "是否删除该视频" } } }, methods: { play: function () { zyapp().com.playVideo(this.video) }, del: function () { this.confirm.isShow = !0 }, yes: function () { n.app.$children[0].$set("video", ""), b.video = "", this.confirm.isShow = !1 }, no: function () { this.confirm.isShow = !1 } } }), Vue.component("Foot", { template: "#foot", props: ["tab", "record", "uploadimgs", "maxcnt"] }), Vue.component("SelectList", { template: "#select-list", props: ["groups"], data: function () { return { messagetype: b.messagetype } }, computed: { needVip: function () { var a, b; for (a = 0; a < this.groups.length; a++) for (b = 0; b < this.groups[a].member.length; b++) if (-1 != this.groups[a].member[b].isvip) return !0; return !1 }, selectedcnt: function () { var b, a = 0; for (b = 0; b < this.groups.length; b++) a += this.groups[b].selectedcnt; return a }, canSmsCount: function () { var b, a = 0; for (b = 0; b < this.groups.length; b++) a += this.groups[b].canSmsCount; return a } }, methods: { select: function (a, c) { (b.messagetype > 0 || t(this.groups[a].member[c].mobile) && 0 != this.groups[a].member[c].isvip) && (this.groups[a].member[c].selected = !this.groups[a].member[c].selected, this.groups[a].member[c].selected ? this.groups[a].selectedcnt++ : this.groups[a].selectedcnt--) }, selectgroup: function (a) { var d, c = this.groups[a].selectedcnt == (b.messagetype > 0 ? this.groups[a].member.length : this.groups[a].canSmsCount); for (d = 0; d < this.groups[a].member.length; d++) (b.messagetype > 0 || t(this.groups[a].member[d].mobile) && 0 != this.groups[a].member[d].isvip) && (this.groups[a].member[d].selected = !c); this.groups[a].selectedcnt = c ? 0 : b.messagetype > 0 ? this.groups[a].member.length : this.groups[a].canSmsCount }, toggle: function (a) { this.groups[a].open = !this.groups[a].open } } }), Vue.component("Confirm", { template: "#confirm", props: ["show", "info", "yes", "no", "yestext", "notext"], watch: { show: function (a) { a ? document.body.classList.add("overflow") : document.body.classList.remove("overflow") } }, ready: function () { this.show && document.body.classList.add("overflow") }, beforeDestroy: function () { document.body.classList.remove("overflow") } }), d = Vue.extend({ template: "#main", data: function () { return { canSendSMS: document.querySelector("#openWebSms").value, entrance: [{ route: "message", title: "发消息", icon: "icon-info", isShow: !0 }, { route: "sms", title: "手机短信", icon: "icon-message", isShow: 1 == document.querySelector("#openWebSms").value }, { route: "picture", title: "发图片", icon: "icon-photo", isShow: !0 }, { route: "video", title: "发视频", icon: "icon-video", isShow: !0 }] } }, methods: { history: function () { zyapp().com.newWindow("/message/sendhistory?uid={uid}&kid={kid}&role={role}") } }, ready: function () { zyapp().com.rightBtn(0), zyapp().com.setTitle("发通知") }, route: { data: function () { b = JSON.parse(JSON.stringify(c)) } } }), e = Vue.extend({ template: "#picture-message-editor", data: function () { return { tab: { audio: !0, word: !0, img: !1 }, imgs: b.imgs, audio: b.audio, content: b.content, maxcnt: 9 } }, computed: {}, methods: { uploadimgs: function () { zyapp().com.uploadImgs(this.maxcnt - this.imgs.length, "insertimgs") }, record: function () { zyapp().com.record("recorded") } }, ready: function () { zyapp().com.setTitle("发图片"), zyapp().com.rightBtn(1, "下一步", "next") }, beforeDestroy: function () { b.content = this.content, b.audio = this.audio, b.messagetype = 2 } }), f = Vue.extend({ template: "#text-message-editor", data: function () { return { tab: { audio: !0, word: !1, img: !0 }, imgs: b.imgs, audio: b.audio, content: b.content, maxcnt: 9 } }, computed: {}, methods: { uploadimgs: function () { zyapp().com.uploadImgs(this.maxcnt - this.imgs.length, "insertimgs") }, record: function () { zyapp().com.record("recorded") } }, ready: function () { zyapp().com.rightBtn(1, "下一步", "next") }, beforeDestroy: function () { b.content = this.content, b.audio = this.audio, b.messagetype = 1 } }), g = Vue.extend({ template: "#sms-editor", data: function () { return { smsLen: a.smsLen, tab: { audio: !1, word: !1, img: !1 }, content: b.content, surpluscnt: a.surpluscnt } }, computed: { enablecnt: function () { return this.smsLen - this.content.length } }, ready: function () { zyapp().com.setTitle("手机短信"), zyapp().com.rightBtn(1, "下一步", "next") }, beforeDestroy: function () { b.content = this.content, b.messagetype = 0 } }), h = Vue.extend({ template: "#video-message-editor", data: function () { return { video: b.video, tab: { audio: !1, word: !0, img: !1 }, content: b.content, confirm: { isShow: !1, info: "是否删除视频" } } }, computed: {}, methods: { uploadvideo: function () { zyapp().com.video("videoed") }, del: function () { this.confirm.info = "是否删除视频", this.confirm.isShow = !0 }, yes: function () { this.video = "", b.video = "", this.confirm.isShow = !1 }, no: function () { this.confirm.isShow = !1 } }, ready: function () { zyapp().com.setTitle("发视频"), zyapp().com.rightBtn(1, "下一步", "next") }, beforeDestroy: function () { b.content = this.content, b.video = this.video, b.messagetype = 3 } }), i = "students", j = Vue.extend({ template: "#selector", data: function () { return { students: JSON.parse(JSON.stringify(a.students)), teachers: JSON.parse(JSON.stringify(a.teachers)), tab: i, onlysendchild: document.querySelector("#onlySendChild").value, time: b.sendtime, sendding: !1, confirm: { isShow: !1, info: "", yesText: "确定", noText: "取消" }, beforeSend: { isShow: !1, info: "", yesText: "确定", noText: "取消" } } }, methods: { shift: function (a) { this.tab = a }, settime: function () { var a, b, c; this.time ? this.time = "" : (a = s(new Date, "yyyy-MM-dd HH:mm:ss"), b = a, c = s(new Date(2099, 11, 31), "yyyy-MM-dd HH:mm:ss"), zyapp().com.datetimePicker("datetime", a, b, c, "settime")) }, yes: function () { 0 == b.messagetype ? (q(this), this.confirm.isShow = !1) : n.go({ path: "selector/receipt" }) }, no: function () { this.confirm.isShow = !1, this.confirm.info.indexOf("选择") >= 0 && (history.go(-2), setTimeout(function () { location.reload() }, 500)) }, send: function () { if (0 == b.messagetype) { if (this.sendding) return; if (this.sendding = !0, !p(this)) return this.sendding = !1, void 0; q(this) } else { if (!p(this)) return; n.go({ path: "selector/receipt" }) } }, dontSend: function () { this.beforeSend.isShow = !1 } }, ready: function () { zyapp().com.setTitle("选择接收人"), zyapp().com.rightBtn(1, "发送", "next") }, beforeDestroy: function () { b.checked = !1 } }), k = Vue.extend({ template: "#text-editor", data: function () { return { content: b.content } }, ready: function () { zyapp().com.rightBtn(1, "确定", "next") } }), l = Vue.extend({ template: "#receipt", data: function () { return { receipt: b.receipt, sendding: !1 } }, methods: { select: function (a) { this.receipt = a, b.receipt = a }, send: function () { r(this) } }, ready: function () { document.body.classList.add("overflow"), zyapp().com.rightBtn(0, "", "") }, beforeDestroy: function () { document.body.classList.remove("overflow"), zyapp().com.rightBtn(1, "发送", "next") } }), m = Vue.extend({}), n = new VueRouter, n.map({ "/": { component: d }, "/message": { name: "message", component: f }, "/sms": { name: "sms", component: g }, "/picture": { name: "picture", component: e }, "/video": { name: "video", component: h }, "/selector": { component: j, subRoutes: { "/receipt": { component: l } } }, "/content": { component: k } }), n.start(m, "#app"), $(window).on("next", function () { var d, e, f, g, c = location.hash.replace("#!", ""); for (d = 0; d < a.students.length; d++) a.students[d].isShow = "借阅会员" == a.students[d].name && "/sms" == c ? !1 : !0; switch (c) { case "/picture": if (!b.imgs.length) return zyapp().com.alert("没有图片内容"), void 0; n.go({ path: "selector" }); break; case "/video": if (!b.video) return zyapp().com.alert("没有视频内容"), void 0; n.go({ path: "selector" }); break; case "/message": if (!document.querySelector("textarea").value && !b.audio.length && !b.imgs.length) return zyapp().com.alert("内容不能为空"), document.querySelector("textarea").focus(), void 0; n.go({ path: "selector" }); break; case "/sms": if (!document.querySelector("textarea").value) return zyapp().com.alert("内容不能为空"), document.querySelector("textarea").focus(), void 0; if (this.app.$children[0].enablecnt < 0) return zyapp().com.alert("内容长度超过限制"), document.querySelector("textarea").focus(), void 0; n.go({ path: "selector" }); break; case "/selector": for (b.students = [], b.teachers = [], d = 0; d < this.app.$children[0].teachers.length; d++) for (e = 0; e < this.app.$children[0].teachers[d].member.length; e++) this.app.$children[0].teachers[d].member[e].selected && b.teachers.push(this.app.$children[0].teachers[d].member[e].userid); for (d = 0; d < this.app.$children[0].students.length; d++) for (e = 0; e < this.app.$children[0].students[d].member.length; e++) this.app.$children[0].students[d].member[e].selected && b.students.indexOf(this.app.$children[0].students[d].member[e].userid) < 0 && b.students.push(this.app.$children[0].students[d].member[e].userid); f = "", g = b.teachers.length + b.students.length, f = g > 0 ? "您选择了" + g + "人，现在发送吗？" : "请选择接受人后再发送", this.app.$children[0].$set("beforeSend", { isShow: !0, info: f, yesText: g > 0 ? "发送" : "", noText: g > 0 ? "稍等" : "好的" }); break; case "/content": b.content = document.querySelector("textarea").value, history.back(), this.app.$children[0].$set("content", b.content) } }.bind(n)), $(window).on("recorded", function (a, c) { var d = c && c.result && c.result.url || ""; this.app.$children[0].$set("audio", d), b.audio = d }.bind(n)), $(window).on("insertimgs", function (a, c) { var e, d = c.result && c.result.imgs || {}; for (e = 0; e < d.length; e++) b.imgs.push({ url: d[e] }); this.app.$children[0].$set("imgs", b.imgs) }.bind(n)), $(window).on("updateimgs", function (a, c) { var e, d = c.result && c.result.imgs || {}; for (b.imgs = [], e = 0; e < d.length; e++) b.imgs.push({ url: d[e] }); this.app.$children[0].$set("imgs", b.imgs) }.bind(n)), $(window).on("videoed", function (a, c) { var d = c.result && c.result.url || ""; this.app.$children[0].$set("video", d), b.video = d }.bind(n)), $(window).on("settime", function (a, c) { var d = c.result && c.result.value || ""; this.app.$children[0].$set("time", s(new Date(d.replace(/-/g, "/")), "yyyy-MM-dd HH:mm")), b.sendtime = d }.bind(n)), $.ajax({ url: "/message/StudentList", data: { uid: document.querySelector("#uid").value, kid: document.querySelector("#kid").value }, success: function (d) { var e, f, g; for (e = 0; e < d.length; e++) for (d[e].canSmsCount = 0, d[e].mobileIllegalCount = 0, f = 0; f < d[e].member.length; f++) t(d[e].member[f].mobile) || d[e].mobileIllegalCount++, t(d[e].member[f].mobile) && 0 != d[e].member[f].isvip && d[e].canSmsCount++; for (location.hash.indexOf("selector") && n.app.$children[0].$set("students", d), g = (document.querySelector("#def_receivers").value || "").split(","), e = 0; e < d.length; e++) for (f = 0; f < d[e].member.length; f++) g.indexOf(d[e].member[f].userid + "") >= 0 && (d[e].open = !0, d[e].selectedcnt++, d[e].member[f].selected = !0, b.students.push(d[e].member[f].userid)); for (c = JSON.parse(JSON.stringify(b)), a.students = d, e = 0; e < a.students.length; e++) a.students[e].isShow = !0 } }), $.ajax({ url: "/message/TeacherList", data: { uid: document.querySelector("#uid").value, kid: document.querySelector("#kid").value }, success: function (d) { var e, f, g, h; for (e = 0; e < d.length; e++) for (d[e].canSmsCount = 0, d[e].mobileIllegalCount = 0, f = 0; f < d[e].member.length; f++) t(d[e].member[f].mobile) || d[e].mobileIllegalCount++, t(d[e].member[f].mobile) && 0 != d[e].member[f].isvip && d[e].canSmsCount++; for (location.hash.indexOf("selector") && n.app.$children[0].$set("teachers", d), g = (document.querySelector("#def_receivers").value || "").split(","), h = "1" == document.querySelector("#onlySendChild").value, e = 0; e < d.length; e++) { for (f = 0; f < d[e].member.length; f++) g.indexOf(d[e].member[f].userid + "") >= 0 ? (d[e].open = !0, d[e].selectedcnt++, d[e].member[f].selected = !0, b.teachers.push(d[e].member[f].userid), document.querySelector("#onlySendChild").value = "0") : h && d[e].member.splice(f--, 1); d[e].selectedcnt > 0 && (i = "teachers"), 0 == d[e].selectedcnt && h && d.splice(e--, 1) } for (c = JSON.parse(JSON.stringify(b)), a.teachers = d, e = 0; e < a.teachers.length; e++) a.teachers[e].isShow = !0 } }) });